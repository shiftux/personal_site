<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <!-- for mobile sites -->
	<title>Welcome to Sandro's site</title>
	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous">
	<link href="../stylesheets/style.css" rel="stylesheet">
    <link href="../stylesheets/blog_style.css" rel="stylesheet">
    <link href="//fonts.googleapis.com/css?family=Roboto:500" rel="stylesheet" type="text/css">
</head>
<body data-spy="scroll" data-target=".navbar" data-offset="50">

<section id="navbarSection" style="padding-bottom: 100px;"></section>

<section id="introImageSection">
        <div id="introCarousel" class="carousel slide" data-ride="carousel">
            <ul class="carousel-indicators">
                <li data-target="#introCarousel" data-slide-to="0" class="active"></li>
                <li data-target="#introCarousel" data-slide-to="1"></li>
                <li data-target="#introCarousel" data-slide-to="2"></li>
            </ul>
            <div class="carousel-inner active">
                <div class="carousel-item active">
                    <img src="../images/cftb_carousel_1.jpeg">
                </div>
                <div class="carousel-item">
                    <img src="../images/cftb_carousel_2.jpeg">
                </div>
                <div class="carousel-item">
                    <img src="../images/cftb_carousel_3.jpeg">
                </div>
            </div>
    </div>
</section>

<section class="blue-text view-width">
    <div class="container-fluid padding blue-text">
		<div class="row text-center">
			<div class="col-12 heading-row">
				<h1 class="heading">Building a member(ship) and class management application for my CrossFit box</h1>
			</div>
		</div>
    </div>
    <p><small>Published September 2020</small></p>
    <h4>Motivation</h4>
    <p>
        For quite a while I was a bit of a CrossFit fanatic and used to go to the box at around 4 times per week. There was a great community and the workouts hit the spot of what I needed in terms of strength and cardio. The only painful part of it was the sign up process for the classes. There was this Doodle sheet where you had to check your name at the date and time you were planning to go. Now Doodle is a great tool for date finding and consensus finding, but if you regularly have to load a grid of around 250 members and 2 weeks full of classes it is not the best-suited tool for the task, it's too slow and the scrolling and finding is just too painful... So I decided to write an app that would allow Tom, the owner, to put his classes online and have people sign-up for classes or go on a wait list if the class was booked. That was back in 2017, and today it is still running.
    </p>
    <h4>The app</h4>
    <b>Roles</b><br>
    <p>
        There's not that many roles to distinguish in such an app, basically you're <b>coach</b> and manage classes and your
        athlete's membership or you're
        <b>athlete</b> and sign up for classes and pay to have your membership extended.
    </p>
    <div class="row">
        <div class="col-lg-3">
            <img src="../images/cftb_tom.png" width="100%">
        </div>
        <div class="col-lg-9">
            <p><i>"The members appreciated the new login system from the beginning on. It's easy to use, simple to understand and
                    most of all stable. Managing the memberships of all athletes has become much simpler and thanks to the new app
                    we have a much better overview of our classes and members."</i> Tom Krebs, owner and head coach</p>
        </div>
    </div>
    <b>Features</b><br>
    <p>
        Let's look at what each role needs from such an app, starting with the <b>athlete's</b> view. As an athlete, at a
        minimum, you want to be able to:
    <ul>
        <li>Create a profile, with password recovery and email verification</li>
        <li>Login to your athlete's profile</li>
        <li>See and change your membership (how many entries remaining, or when does my membership run out)</li>
        <li>See list of available classes online</li>
        <li>Sign up for or out of a class online</li>
        <li>See which classes you're currently registered for</li>
        <li>Put yourself on a waiting list if classes are full</li>
    </ul>
    On the other end, as a <b>coach</b> you want to:
    <ul>
        <li>Login to your coach's profile</li>
        <li>See and change the memberships of all athletes</li>
        <li>Manage the different types of membership (annual, monthly, number of entries, etc) for every user</li>
        <li>Populate the calendar of classes, add or remove individual classes</li>
        <li>Manage the type of class (workout of the day, open gym, yoga, etc)</li>
        <li>Manage which coach takes care of what class</li>
        <li>Manage how many athletes can sign up per class</li>
        <li>Get statistics about classes and users</li>
        <li>Send users emails</li>
    </ul>
    </p>
    <div class="row">
        <div class="col-sm-12 text-center">
            <img src="../images/cftb_diagram.png" width="100%">
            <p class="caption">Architecture diagram</p>
        </div>
    </div>
    <p>
        <b>Tools and build</b><br>
        Back then a friend of mine introduced me to Meteor.JS, a web framework based on Node.js which leverages a
        distributed data protocol and a publishâ€“subscribe pattern to automatically propagate data changes to clients without
        requiring the developer to write any synchronization code. This last fact was particularly interesting to me because
        it made sure that at any given time if someone signed up to a class the backend automagically took care of updating
        all clients and making sure that classes were filled synchronously. Meteor relies on MongoDB as underlying database,
        which is pretty easy to work with (as long as you don't have to manually make too many queries on the DB itself).
    </p>
    <h4>Hosting and availability</h4>
    <p>
        <b>Deployment</b><br>
        To facilitate, automate and if need be easily repeat the deployment of the application, it is all scripted in Ansible scripts which completely automate and standardize the deployment of the application. If the application would need to be migrated or a second instance should be deployed, all it would require to be deployed on a new host are the Ansible dependencies on the host (python) and the running of 1 playbook.
    </p>
    <p>
        <b>Hosting</b><br>
        The complete app is obviously hosted on a public cloud hosting service. Starting out with a bare debian Linux image.
        I am a big fan of containerized micro service architecture and opted for a Docker hosted approach from the start.
        This has the great advantage that I can develop and test locally and ship tested finished containers to the VM, next
        to all obvious advantages of a micro service architecture. Coupling this with Docker-Compose to handle the the
        complete app deployment including DB and nginx proxy and the auto-restart of any failed container.
    </p>
    <div class="row">
        <div class="col-sm-12 text-center">
            <img src="../images/cftb_stats.png" width="100%">
            <p class="caption">Example of statistics presented to the coaches</p>
        </div>
    </div>
    <p>
        <b>Load Balancing</b><br>
        Back then the box had around 250 members, some leaving a little more coming, we expected the total number not to
        exceed 500 athletes + coaches. This means the load on the service at any given time is very low. Clearly numbers
        that don't require a sophisticated load balancing, a hypothesis which has been holding true over the past 3 years.
        The same goes for the server itself, a single instance of the meteor server can cope with the entire load at any
        time.
    </p>
    <p>
        <b>Database resiliency and backup</b><br>
        The heat of the whole application clearly is the database, it stores all the members, the classes and the
        subscriptions. As for the load balancing the number of requests is very low, given the limited number of athletes,
        so I was not worried about DB performance issues. Meteor already takes care of synchronization across all clients
        and the server component therefore handles DB writing without concurrency issues, especially since there is only 1
        server instance running. <br>
        For the Backup Tom, the manager of the box, and me were discussing a couple of options. In the end we decided to go
        for a pragmatic time-based approach where a Cron job takes care of backing up the DB every 15 minutes and exporting
        a copy of it to an external DB at my home, where 2 weeks of backups are stored. He argued that he knew all his
        members and could see if someone was in a class or not in case the DB failed and some transactions would have been
        lost in the 15 minute time frame. We preferred this over a complicated fully resilient setup, since it kept server
        and maintenance costs low. And so far in the over 3 years of the app running, it had never failed.
    </p>
    <p>
        <b>Testing</b><br>
        Writing most of the code for this app in JavaScript, I chose Mocha as the testing framework. The coverage of my tests in this app is not as extensive as I would like it to be, but the essential is there.
    </p>
    <p>
        <b>Monitoring</b><br>
        As there are only 3 components running and the resource consumption of the whole application is extremely low, the
        monitoring of it all is relatively simple as well. I am using uptime robot to alert me if the service is up, this
        queries the login endpoint and attempts a login with an uptime user. If I get a response back it means the proxy is
        redirecting the request, the app is responding and able to query the user data from the database. This is basically
        already enough. Additionally I make sure that the disk is not running out with log rotation and a simple disk
        monitoring utility provided by the cloud hosting provider.
    </p>
    <div class="row">
        <div class="col-sm-12 text-center">
            <img src="../images/cftb_uptime.png" width="100%">
            <p class="caption">Screenshot of the uptime graph on uptimerobot.com</p>
        </div>
    </div>
    <h4>Hiccups and learnings</h4>
    <p>
        Generally the app has been running without issues since early 2017 and so far people are very happy with it. <br>
        Of course there had been hiccups and those were mainly caused by my inexperience and neglect. One time I forgot to
        update the letsencrypt SSL certificate, leading to people not being able to access the app from devices which block
        insecure connections to a https port (iPhones for example). As (bad) luck would have it I was on vacation just as
        the certificate ran out with my laptop at home where the the private key to access my server was stored. Now I have
        several timed alerts to make sure the cert is updated in time.<br>
        The other unwanted incident was related to my handling of Github. Out of neglect I had the login for my mailgun
        account, the email service I was using, hardcoded in the mail handling code. Obviously a big no-no! The mail account
        was hacked and used to send spam, a lot of spam! So much spam that the bill at the end of the month arose to $500.
        Luckily my credit card company accepted my claim that the charge was fraudulent and refunded it. Needless to say
        that this was a lesson of github login management I am going to remember for the rest of my life!
        Now looking back I can smile about my mistakes and am happy I was able to learn from them! It being the first app I
        had built, and am still operating and maintaining end to end on my own, I've been very grateful for all lessons
        learned and am encouraged by the fact that is is still being used today!
    </p>
    <h4>Conclusion</h4>
    <p>
        In terms of high availability design and also in terms of monitoring there would be some additional work required for an app that would scale beyond the couple of athlete's at Tom's Box. So from a full-scale devops perspective it's a rather simple application. Nevertheless it has been running for over 3 years without any major issues (that I didn't brin on myself), so the pragmatic approach has proven resilient enough for the given requirements. <br>
        The whole experience was a great exercise to learn how to build, operate and maintain a hosted web application. It is still running, I learned a lot, Tom, the manager, as well as the community are enjoying using it. All in a success!
    </p>
</section>

<!--- Footer -->
<footer id="footer" class="blue-background"></footer>

<!--- Bootstrap scripts inclusions -->
<script src="https://code.jquery.com/jquery-3.5.1.js" integrity="sha384-/LjQZzcpTzaYn7qWqRIWYC5l8FWEZ2bIHIz0D73Uzba4pShEcdLdZyZkI4Kv676E" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js" integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js" integrity="sha384-B4gt1jrGC7Jh4AgTPSdUtOBvfO8shuf57BaghqFfPlYxofvL8/KUEfYiJOMMV+rV" crossorigin="anonymous"></script>
<script src="https://use.fontawesome.com/releases/v5.0.8/js/all.js"></script> <!-- for social media icons -->

<!-- include navbar -->
<script>
    window.onload = function () {
        $("#navbarSection").load("../index.html #navbarSection");
        $("#footer").load("../index.html #footer");    }
</script>

</body>
</html>
